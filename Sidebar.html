<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      font-size: 14px;
      margin: 0;
      padding: 16px;
      color: #202124;
    }

    h2 {
      font-size: 18px;
      font-weight: 500;
      margin: 0 0 16px 0;
      color: #1a73e8;
    }

    h3 {
      font-size: 14px;
      font-weight: 500;
      margin: 16px 0 8px 0;
      color: #202124;
    }

    .section {
      margin-bottom: 20px;
    }

    .template-status {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .template-status.not-set {
      background: #fef7e0;
      border: 1px solid #fbbc04;
    }

    .template-status.set {
      background: #e6f4ea;
      border: 1px solid #34a853;
    }

    .template-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .template-hint {
      font-size: 12px;
      color: #5f6368;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 100%;
      margin-top: 8px;
    }

    .btn-primary {
      background-color: #1a73e8;
      color: white;
    }

    .btn-primary:hover {
      background-color: #1557b0;
    }

    .btn-primary:disabled {
      background-color: #dadce0;
      cursor: not-allowed;
    }

    .btn-secondary {
      background-color: #fff;
      color: #1a73e8;
      border: 1px solid #dadce0;
    }

    .btn-secondary:hover {
      background-color: #f8f9fa;
    }

    .btn-success {
      background-color: #34a853;
      color: white;
    }

    .btn-success:hover {
      background-color: #2d8e47;
    }

    .btn-warning {
      background-color: #fbbc04;
      color: #202124;
    }

    .btn-warning:hover {
      background-color: #e5a800;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      width: auto;
      margin: 0;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #5f6368;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .results {
      display: none;
    }

    .results.show {
      display: block;
    }

    .score-container {
      text-align: center;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .score {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .score.high {
      color: #34a853;
    }

    .score.medium {
      color: #fbbc04;
    }

    .score.low {
      color: #ea4335;
    }

    .score-label {
      color: #5f6368;
      font-size: 12px;
    }

    .summary {
      background: #e8f0fe;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      color: #174ea6;
    }

    .list-section {
      margin-bottom: 16px;
    }

    .list-section h4 {
      font-size: 13px;
      font-weight: 500;
      margin: 0 0 8px 0;
      color: #5f6368;
    }

    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      display: inline-block;
      padding: 4px 10px;
      background: #e8eaed;
      border-radius: 16px;
      font-size: 12px;
      color: #3c4043;
    }

    .chip.success {
      background: #e6f4ea;
      color: #137333;
    }

    .chip.warning {
      background: #fef7e0;
      color: #b05a00;
    }

    .chip.addable {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding-right: 4px;
    }

    .chip-add-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border: none;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.1);
      color: inherit;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      transition: background-color 0.15s;
    }

    .chip-add-btn:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    .chip.added {
      background: #e6f4ea;
      color: #137333;
    }

    .chip.added .chip-add-btn {
      display: none;
    }

    .chip.info {
      background: #e8f0fe;
      color: #174ea6;
    }

    .error {
      background: #fce8e6;
      color: #c5221f;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }

    .error.show {
      display: block;
    }

    .tailoring-results {
      display: none;
    }

    .tailoring-results.show {
      display: block;
    }

    .copy-info {
      background: #e6f4ea;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .copy-info a {
      color: #137333;
      text-decoration: none;
      font-weight: 500;
    }

    .copy-info a:hover {
      text-decoration: underline;
    }

    .change-card {
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .change-section {
      font-size: 11px;
      color: #5f6368;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .change-original {
      background: #fce8e6;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 13px;
      text-decoration: line-through;
      color: #5f6368;
    }

    .change-tailored {
      background: #e6f4ea;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .change-reason {
      font-size: 12px;
      color: #5f6368;
      font-style: italic;
    }

    .change-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .rephrase-panel {
      margin-top: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      display: none;
    }

    .rephrase-panel.show {
      display: block;
    }

    .rephrase-panel textarea {
      min-height: 60px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .rephrase-panel .btn-row {
      display: flex;
      gap: 8px;
    }

    .btn-rephrase {
      background-color: #fff;
      color: #5f6368;
      border: 1px solid #dadce0;
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-rephrase:hover {
      background-color: #f8f9fa;
      color: #202124;
    }

    .change-actions .btn {
      width: auto;
      padding: 6px 12px;
      font-size: 12px;
      margin: 0;
    }

    .notes {
      background: #fff8e1;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      color: #6a4c00;
      margin-top: 16px;
    }

    .divider {
      height: 1px;
      background: #dadce0;
      margin: 20px 0;
    }

    .action-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    /* Intake Screen Styles */
    .intake-screen {
      display: none;
    }

    .intake-screen.show {
      display: block;
    }

    .intake-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .intake-header h3 {
      margin: 0 0 8px 0;
      color: #1a73e8;
    }

    .intake-header p {
      margin: 0;
      font-size: 13px;
      color: #5f6368;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #202124;
    }

    .form-group select,
    .form-group input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: #fff;
    }

    .form-group select:focus,
    .form-group input[type="text"]:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }

    .form-hint {
      font-size: 11px;
      color: #5f6368;
      margin-top: 4px;
    }

    .profile-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: #e8f0fe;
      border-radius: 16px;
      font-size: 12px;
      color: #174ea6;
      cursor: pointer;
      transition: background 0.2s;
    }

    .profile-badge:hover {
      background: #d2e3fc;
    }

    .profile-badge svg {
      width: 14px;
      height: 14px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .header-row h2 {
      margin: 0;
    }
  </style>
</head>
<body>
  <!-- Header with profile badge -->
  <div class="header-row">
    <h2>Resume Tailor</h2>
    <div id="profile-badge" class="profile-badge" onclick="showIntakeScreen(true)" style="display: none;" title="Edit your profile">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      <span id="profile-badge-text">Tech · Mid-career</span>
    </div>
  </div>

  <!-- Intake Screen (shown on first use) -->
  <div id="intake-screen" class="intake-screen">
    <div class="intake-header">
      <h3>Let's personalize your experience</h3>
      <p>Tell us about your background so we can tailor suggestions to your industry and career stage.</p>
    </div>

    <div class="form-group">
      <label for="intake-industry">What industry are you in?</label>
      <select id="intake-industry">
        <option value="">Select your industry...</option>
        <option value="Technology / Software">Technology / Software</option>
        <option value="Finance / Banking">Finance / Banking</option>
        <option value="Healthcare / Medical">Healthcare / Medical</option>
        <option value="Marketing / Advertising">Marketing / Advertising</option>
        <option value="Sales / Business Development">Sales / Business Development</option>
        <option value="Education / Academia">Education / Academia</option>
        <option value="Engineering / Manufacturing">Engineering / Manufacturing</option>
        <option value="Legal / Compliance">Legal / Compliance</option>
        <option value="Human Resources">Human Resources</option>
        <option value="Design / Creative">Design / Creative</option>
        <option value="Consulting">Consulting</option>
        <option value="Government / Public Sector">Government / Public Sector</option>
        <option value="Nonprofit / NGO">Nonprofit / NGO</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <div class="form-group" id="other-industry-group" style="display: none;">
      <label for="intake-other-industry">Specify your industry</label>
      <input type="text" id="intake-other-industry" placeholder="e.g., Real Estate, Hospitality...">
    </div>

    <div class="form-group">
      <label for="intake-career-stage">What's your career stage?</label>
      <select id="intake-career-stage">
        <option value="">Select your career stage...</option>
        <option value="Entry-level (0-2 years)">Entry-level (0-2 years)</option>
        <option value="Early career (2-5 years)">Early career (2-5 years)</option>
        <option value="Mid-career (5-10 years)">Mid-career (5-10 years)</option>
        <option value="Senior (10-15 years)">Senior (10-15 years)</option>
        <option value="Executive / Leadership (15+ years)">Executive / Leadership (15+ years)</option>
        <option value="Career changer">Career changer</option>
        <option value="Returning to workforce">Returning to workforce</option>
      </select>
    </div>

    <div class="form-group">
      <label for="intake-specialization">Specialization or focus area (optional)</label>
      <input type="text" id="intake-specialization" placeholder="e.g., Frontend Development, Data Science, Product Management...">
      <div class="form-hint">This helps us understand what aspects of your experience to emphasize</div>
    </div>

    <div class="form-group">
      <label for="intake-target-role">Target role type (optional)</label>
      <select id="intake-target-role">
        <option value="">Select if applicable...</option>
        <option value="Individual Contributor">Individual Contributor</option>
        <option value="Team Lead">Team Lead</option>
        <option value="Manager">Manager</option>
        <option value="Director">Director</option>
        <option value="VP / Executive">VP / Executive</option>
        <option value="Freelance / Contract">Freelance / Contract</option>
      </select>
    </div>

    <button id="intake-save-btn" class="btn btn-primary" onclick="saveIntakeProfile()">
      Continue
    </button>

    <button id="intake-skip-btn" class="btn btn-secondary" onclick="skipIntake()" style="margin-top: 8px; display: none;">
      Skip for now
    </button>
  </div>

  <!-- Template Status -->
  <div id="template-status" class="template-status not-set">
    <div class="template-name" id="template-name">No template set</div>
    <div class="template-hint" id="template-hint">
      Open your resume and click "Set This Doc as Template" in the add-on menu.
    </div>
  </div>

  <!-- Match Threshold Slider -->
  <div id="threshold-section" class="settings-section" style="margin-bottom: 16px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
      <label style="font-size: 12px; color: #5f6368;">Min match to tailor:</label>
      <span id="threshold-value" style="font-size: 12px; font-weight: 500; color: #1a73e8;">80%</span>
    </div>
    <input type="range" id="threshold-slider" min="50" max="100" value="80" step="5"
           style="width: 100%; cursor: pointer;" onchange="updateThreshold(this.value)">
    <div style="display: flex; justify-content: space-between; font-size: 10px; color: #9aa0a6;">
      <span>50% (lenient)</span>
      <span>100% (strict)</span>
    </div>
  </div>

  <!-- AI Provider -->
  <div id="ai-provider-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;">
    <span style="font-size: 12px; color: #5f6368;">AI: <strong id="ai-provider-name">Loading...</strong></span>
    <a href="#" onclick="openAISettings(); return false;" style="font-size: 11px; color: #1a73e8; text-decoration: none;">Change</a>
  </div>

  <!-- Error Display -->
  <div id="error" class="error"></div>

  <!-- Job Description Input -->
  <div id="input-section" class="section">
    <label for="job-description"><strong>Job Posting URL or Description:</strong></label>
    <textarea id="job-description" placeholder="Paste a job URL (e.g., https://linkedin.com/jobs/...) or the full job description text..."></textarea>
    <button id="analyze-btn" class="btn btn-primary" onclick="analyze()">
      Analyze Match
    </button>
    <p style="font-size: 11px; color: #5f6368; margin-top: 8px; text-align: center;">
      Tip: If URL doesn't work (login required), copy and paste the job text instead.
    </p>
  </div>

  <!-- Loading State -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div id="loading-text">Analyzing your resume...</div>
  </div>

  <!-- Analysis Results -->
  <div id="results" class="results">
    <div class="score-container">
      <div id="score" class="score">--</div>
      <div class="score-label">Match Score</div>
    </div>

    <div id="summary" class="summary"></div>

    <div class="list-section">
      <h4>Strengths</h4>
      <div id="strengths" class="chip-list"></div>
    </div>

    <div class="list-section">
      <h4>Gaps</h4>
      <div id="gaps" class="chip-list"></div>
    </div>

    <div class="list-section">
      <h4>Keywords Matched</h4>
      <div id="keywords-matched" class="chip-list"></div>
    </div>

    <div class="list-section" id="keywords-to-add-section" style="display: none;">
      <h4>Add to Skills Section</h4>
      <p style="font-size: 11px; color: #5f6368; margin: 0 0 8px 0;">You have experience with these but they're not in your Skills section:</p>
      <div id="keywords-to-add" class="chip-list"></div>
    </div>

    <div class="list-section">
      <h4>Keywords Missing</h4>
      <div id="keywords-missing" class="chip-list"></div>
    </div>

    <div id="recommendation" class="notes"></div>

    <div class="divider"></div>

    <div id="tailor-section">
      <button id="tailor-btn" class="btn btn-success" onclick="tailor()">
        Create Tailored Copy
      </button>
      <p id="tailor-note" style="font-size: 12px; color: #5f6368; text-align: center; margin-top: 8px;"></p>
    </div>

    <button class="btn btn-secondary" onclick="reset()">
      Start Over
    </button>
  </div>

  <!-- Pre-Tailor Questionnaire -->
  <div id="pre-tailor" class="results" style="display: none;">
    <h3>Before We Tailor...</h3>

    <div style="background: #e8f0fe; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
      <p style="margin: 0; font-size: 13px; color: #174ea6;">
        We found some gaps between your resume and this job. Do you have relevant experience that's not currently on your resume?
      </p>
    </div>

    <div id="pre-tailor-gaps" style="margin-bottom: 16px;">
      <h4 style="font-size: 13px; font-weight: 500; margin: 0 0 8px 0; color: #5f6368;">Skills/experience the job is looking for:</h4>
      <div id="gaps-list" class="chip-list"></div>
    </div>

    <div style="margin-bottom: 16px;">
      <label for="additional-context" style="font-size: 13px; font-weight: 500; color: #202124; display: block; margin-bottom: 8px;">
        Tell us about any relevant experience (optional):
      </label>
      <textarea id="additional-context"
                placeholder="Example: I automated deployment pipelines using GitHub Actions at my last job. I also have experience with CI/CD from personal projects..."
                style="min-height: 100px;"></textarea>
      <p style="font-size: 11px; color: #5f6368; margin-top: 4px;">
        This helps us tailor authentically. We'll only include experience you actually have.
      </p>
    </div>

    <button id="proceed-tailor-btn" class="btn btn-success" onclick="proceedWithTailoring()">
      Continue to Tailor
    </button>
    <button class="btn btn-secondary" onclick="backToResults()" style="margin-top: 8px;">
      Back to Analysis
    </button>
  </div>

  <!-- Tailoring Results -->
  <div id="tailoring-results" class="tailoring-results">
    <h3>Tailored Resume Created</h3>

    <!-- Match Score Display (from analysis) -->
    <div id="tailoring-match-score" class="score-container" style="padding: 12px; margin-bottom: 12px;">
      <div id="tailoring-score" class="score" style="font-size: 36px;">--</div>
      <div class="score-label">Match Score</div>
    </div>

    <div id="copy-info" class="copy-info">
      <div style="margin-bottom: 8px;">Your tailored resume is open in a new tab:</div>
      <a id="copy-link" href="#" target="_blank">Open Tailored Resume</a>
      <div style="font-size: 11px; color: #137333; margin-top: 4px;">Changes are highlighted in the document for your review.</div>
    </div>

    <h3>Suggested Changes</h3>
    <p style="font-size: 12px; color: #5f6368; margin-bottom: 12px;">
      Changes are highlighted in your document. Review and accept/reject each one.
    </p>

    <div class="action-bar">
      <button class="btn btn-success btn-small" onclick="acceptAllChanges()">Accept All</button>
      <button class="btn btn-secondary btn-small" onclick="rejectAllChanges()">Reject All</button>
    </div>

    <div id="changes-list"></div>
    <div id="tailoring-notes" class="notes" style="display: none;"></div>

    <div class="divider"></div>

    <button class="btn btn-secondary" onclick="reset()">
      Tailor for Another Job
    </button>
  </div>

  <script>
    let currentAnalysis = null;
    let jobDescription = '';
    let candidateName = '';
    let currentCopyId = null;
    let currentChanges = [];
    let currentRemovals = [];
    let templateCheckInterval = null;
    let userProfile = null;
    let isEditingProfile = false;

    // Initialize - check template status and load settings
    document.addEventListener('DOMContentLoaded', function() {
      // First check if user has a profile, show intake if not
      checkUserProfile();
      loadThresholdSetting();
      loadAIProvider();
      // Check if this document has pending changes to review
      checkPendingChanges();

      // Handle "Other" industry selection
      document.getElementById('intake-industry').addEventListener('change', function() {
        const otherGroup = document.getElementById('other-industry-group');
        if (this.value === 'Other') {
          otherGroup.style.display = 'block';
        } else {
          otherGroup.style.display = 'none';
        }
      });
    });

    // ==================== User Profile / Intake ====================

    function checkUserProfile() {
      google.script.run
        .withSuccessHandler(function(profile) {
          userProfile = profile;
          if (profile) {
            // User has profile, show main UI
            showMainUI();
            updateProfileBadge(profile);
          } else {
            // No profile, show intake screen
            showIntakeScreen(false);
          }
          // Always check template status
          checkTemplateStatus();
        })
        .withFailureHandler(function() {
          // On error, just show main UI
          showMainUI();
          checkTemplateStatus();
        })
        .getUserProfile();
    }

    function showIntakeScreen(isEditing) {
      isEditingProfile = isEditing;

      // Hide main UI elements
      document.getElementById('template-status').style.display = 'none';
      document.getElementById('threshold-section').style.display = 'none';
      document.getElementById('input-section').style.display = 'none';
      document.getElementById('results').classList.remove('show');
      document.getElementById('tailoring-results').classList.remove('show');
      document.getElementById('profile-badge').style.display = 'none';
      document.getElementById('ai-provider-row').style.display = 'none';
      document.getElementById('error').classList.remove('show');
      document.getElementById('pre-tailor').style.display = 'none';

      // Show intake screen
      document.getElementById('intake-screen').classList.add('show');

      // Update button text based on context
      const saveBtn = document.getElementById('intake-save-btn');
      const skipBtn = document.getElementById('intake-skip-btn');

      if (isEditing) {
        saveBtn.textContent = 'Save Changes';
        skipBtn.style.display = 'block';
        skipBtn.textContent = 'Cancel';

        // Pre-fill with existing profile
        if (userProfile) {
          const industrySelect = document.getElementById('intake-industry');
          const matchingOption = Array.from(industrySelect.options).find(opt => opt.value === userProfile.industry);
          if (matchingOption) {
            industrySelect.value = userProfile.industry;
          } else if (userProfile.industry) {
            industrySelect.value = 'Other';
            document.getElementById('other-industry-group').style.display = 'block';
            document.getElementById('intake-other-industry').value = userProfile.industry;
          }

          document.getElementById('intake-career-stage').value = userProfile.careerStage || '';
          document.getElementById('intake-specialization').value = userProfile.specialization || '';
          document.getElementById('intake-target-role').value = userProfile.targetRoleType || '';
        }
      } else {
        saveBtn.textContent = 'Continue';
        skipBtn.style.display = 'none';
      }
    }

    function showMainUI() {
      document.getElementById('intake-screen').classList.remove('show');
      document.getElementById('template-status').style.display = 'block';
      document.getElementById('threshold-section').style.display = 'block';
      document.getElementById('input-section').style.display = 'block';
      document.getElementById('ai-provider-row').style.display = 'flex';

      if (userProfile) {
        document.getElementById('profile-badge').style.display = 'flex';
      }
    }

    function updateProfileBadge(profile) {
      if (!profile) return;

      const badge = document.getElementById('profile-badge');
      const badgeText = document.getElementById('profile-badge-text');

      // Create short display text
      let industryShort = profile.industry.split(' / ')[0].split(' ')[0]; // "Technology / Software" -> "Technology" -> "Technology"
      if (industryShort.length > 12) industryShort = industryShort.substring(0, 10) + '...';

      let stageShort = profile.careerStage.split(' (')[0]; // "Mid-career (5-10 years)" -> "Mid-career"

      badgeText.textContent = `${industryShort} · ${stageShort}`;
      badge.style.display = 'flex';
    }

    function saveIntakeProfile() {
      const industrySelect = document.getElementById('intake-industry');
      let industry = industrySelect.value;

      // Handle "Other" industry
      if (industry === 'Other') {
        industry = document.getElementById('intake-other-industry').value.trim();
        if (!industry) {
          alert('Please specify your industry.');
          return;
        }
      }

      const careerStage = document.getElementById('intake-career-stage').value;
      const specialization = document.getElementById('intake-specialization').value.trim();
      const targetRoleType = document.getElementById('intake-target-role').value;

      if (!industry) {
        alert('Please select your industry.');
        return;
      }

      if (!careerStage) {
        alert('Please select your career stage.');
        return;
      }

      const saveBtn = document.getElementById('intake-save-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      const profile = {
        industry: industry,
        careerStage: careerStage,
        specialization: specialization,
        targetRoleType: targetRoleType
      };

      google.script.run
        .withSuccessHandler(function(result) {
          saveBtn.disabled = false;
          if (result.success) {
            userProfile = result.profile;
            updateProfileBadge(result.profile);
            showMainUI();
          } else {
            saveBtn.textContent = isEditingProfile ? 'Save Changes' : 'Continue';
            alert(result.error || 'Failed to save profile.');
          }
        })
        .withFailureHandler(function(err) {
          saveBtn.disabled = false;
          saveBtn.textContent = isEditingProfile ? 'Save Changes' : 'Continue';
          alert('Error saving profile: ' + (err.message || 'Unknown error'));
        })
        .saveUserProfile(profile);
    }

    function skipIntake() {
      // Only available when editing - just go back to main UI
      showMainUI();
    }

    function checkPendingChanges() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.changes && result.changes.length > 0) {
            // This doc has pending changes - show review UI
            currentCopyId = result.docId;
            currentChanges = result.changes;
            showPendingChangesUI(result);
          }
        })
        .withFailureHandler(function() {
          // No pending changes or error - proceed normally
        })
        .getPendingChangesForCurrentDoc();
    }

    function showPendingChangesUI(pendingData) {
      // Hide other sections
      document.getElementById('input-section').style.display = 'none';
      document.getElementById('results').classList.remove('show');
      document.getElementById('threshold-section').style.display = 'none';

      // Update copy info
      const copyInfo = document.getElementById('copy-info');
      copyInfo.innerHTML = `
        <div style="margin-bottom: 8px;"><strong>Reviewing:</strong> ${escapeHtml(pendingData.docName)}</div>
        <div style="font-size: 11px; color: #137333;">Changes are highlighted in this document for your review.</div>
      `;

      // Display the changes
      displayTailoringResults({ changes: pendingData.changes }, null);
    }

    function loadThresholdSetting() {
      google.script.run
        .withSuccessHandler(function(score) {
          document.getElementById('threshold-slider').value = score;
          document.getElementById('threshold-value').textContent = score + '%';
        })
        .getMinMatchScore();
    }

    function loadAIProvider() {
      google.script.run
        .withSuccessHandler(function(settings) {
          const provider = settings.providers.find(p => p.id === settings.currentProvider);
          const nameEl = document.getElementById('ai-provider-name');
          if (provider) {
            nameEl.textContent = provider.name.split(' ')[0]; // Just "Claude", "GPT", or "Gemini"
            if (!provider.hasKey) {
              nameEl.innerHTML += ' <span style="color: #ea4335; font-size: 10px;">(no key)</span>';
            }
          } else {
            nameEl.textContent = 'Not configured';
          }
        })
        .withFailureHandler(function() {
          document.getElementById('ai-provider-name').textContent = 'Error';
        })
        .getAISettings();
    }

    function openAISettings() {
      google.script.run.showApiKeyDialog();
      // Start polling to detect when settings change (dialog doesn't notify sidebar)
      startAIProviderPolling();
    }

    var aiProviderPollInterval = null;
    function startAIProviderPolling() {
      if (aiProviderPollInterval) return;
      // Poll every 2 seconds while dialog might be open
      aiProviderPollInterval = setInterval(function() {
        loadAIProvider();
      }, 2000);
      // Stop polling after 60 seconds (user probably closed dialog by then)
      setTimeout(stopAIProviderPolling, 60000);
    }

    function stopAIProviderPolling() {
      if (aiProviderPollInterval) {
        clearInterval(aiProviderPollInterval);
        aiProviderPollInterval = null;
      }
    }

    function updateThreshold(value) {
      document.getElementById('threshold-value').textContent = value + '%';
      google.script.run.setMinMatchScore(parseInt(value, 10));
    }

    // Start polling for template status if not set
    function startTemplatePolling() {
      if (templateCheckInterval) return; // Already polling
      templateCheckInterval = setInterval(function() {
        google.script.run
          .withSuccessHandler(function(info) {
            if (info.hasTemplate) {
              handleTemplateStatus(info);
              stopTemplatePolling();
            }
          })
          .getTemplateInfo();
      }, 2000); // Check every 2 seconds
    }

    function stopTemplatePolling() {
      if (templateCheckInterval) {
        clearInterval(templateCheckInterval);
        templateCheckInterval = null;
      }
    }

    function checkTemplateStatus() {
      google.script.run
        .withSuccessHandler(handleTemplateStatus)
        .withFailureHandler(function() {
          // Silently fail - template status will show as not set
        })
        .getTemplateInfo();
    }

    function handleTemplateStatus(info) {
      const statusEl = document.getElementById('template-status');
      const nameEl = document.getElementById('template-name');
      const hintEl = document.getElementById('template-hint');

      if (info.hasTemplate) {
        statusEl.classList.remove('not-set');
        statusEl.classList.add('set');
        nameEl.textContent = 'Template: ' + info.templateName;
        hintEl.textContent = 'Your original resume will not be modified.';
        stopTemplatePolling(); // Stop polling once template is set
      } else {
        statusEl.classList.remove('set');
        statusEl.classList.add('not-set');
        nameEl.textContent = 'No template set';
        hintEl.textContent = 'Open your resume and click "Set This Doc as Template" in the add-on menu.';
        startTemplatePolling(); // Start polling to detect when template is set
      }
    }

    function showError(message) {
      const el = document.getElementById('error');
      el.textContent = message;
      el.classList.add('show');
    }

    function hideError() {
      document.getElementById('error').classList.remove('show');
    }

    function showLoading(text) {
      document.getElementById('loading-text').textContent = text;
      document.getElementById('loading').classList.add('show');
      document.getElementById('input-section').style.display = 'none';
      document.getElementById('results').classList.remove('show');
      document.getElementById('tailoring-results').classList.remove('show');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
    }

    function analyze() {
      hideError();
      jobDescription = document.getElementById('job-description').value.trim();

      if (!jobDescription) {
        showError('Please paste a job description first.');
        return;
      }

      // Check if it's a URL to show appropriate loading message
      const isUrl = jobDescription.match(/^https?:\/\//i);
      showLoading(isUrl ? 'Fetching job posting and analyzing...' : 'Analyzing your resume against the job description...');

      google.script.run
        .withSuccessHandler(handleAnalysisResult)
        .withFailureHandler(handleError)
        .analyzeJob(jobDescription);
    }

    function handleAnalysisResult(result) {
      hideLoading();

      if (!result.success) {
        showError(result.error);
        document.getElementById('input-section').style.display = 'block';
        return;
      }

      currentAnalysis = result.analysis;
      candidateName = result.candidateName || '';
      displayResults(result);
    }

    function displayResults(result) {
      const analysis = result.analysis;

      // Score
      const scoreEl = document.getElementById('score');
      scoreEl.textContent = analysis.matchScore + '%';
      scoreEl.className = 'score ' + (
        analysis.matchScore >= 80 ? 'high' :
        analysis.matchScore >= 60 ? 'medium' : 'low'
      );

      // Summary
      document.getElementById('summary').textContent = analysis.summary;

      // Show basic analysis notice if applicable
      let basicNoticeEl = document.getElementById('basic-analysis-notice');
      if (!basicNoticeEl) {
        basicNoticeEl = document.createElement('div');
        basicNoticeEl.id = 'basic-analysis-notice';
        basicNoticeEl.style.cssText = 'background: #fef7e0; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; color: #6a4c00;';
        document.getElementById('summary').after(basicNoticeEl);
      }

      if (analysis.isBasicAnalysis) {
        basicNoticeEl.innerHTML = `
          <strong>Basic Analysis Mode</strong><br>
          <span style="font-size: 12px;">This analysis uses keyword matching only. For AI-powered insights and resume tailoring,
          <a href="#" onclick="openAISettings(); return false;" style="color: #6a4c00; text-decoration: underline;">configure an AI provider</a>.</span>
        `;
        basicNoticeEl.style.display = 'block';
      } else {
        basicNoticeEl.style.display = 'none';
      }

      // Strengths
      document.getElementById('strengths').innerHTML =
        (analysis.strengths || []).map(s => `<span class="chip success">${s}</span>`).join('');

      // Gaps
      document.getElementById('gaps').innerHTML =
        (analysis.gaps || []).map(g => `<span class="chip warning">${g}</span>`).join('');

      // Keywords
      document.getElementById('keywords-matched').innerHTML =
        (analysis.keywordsMatched || []).map(k => `<span class="chip success">${escapeHtml(k)}</span>`).join('');

      // Keywords to add to Skills section (has experience, but not listed as skill)
      const keywordsToAdd = analysis.keywordsToAddToSkills || [];
      const toAddSection = document.getElementById('keywords-to-add-section');
      if (keywordsToAdd.length > 0) {
        toAddSection.style.display = 'block';
        document.getElementById('keywords-to-add').innerHTML =
          keywordsToAdd.map(k => `
            <span class="chip info addable" data-keyword="${escapeHtml(k)}" data-original-class="info">
              ${escapeHtml(k)}
              <button class="chip-add-btn" onclick="addSkillToResume('${escapeHtml(k).replace(/'/g, "\\'")}', this)" title="Add to Skills section">+</button>
            </span>
          `).join('');
      } else {
        toAddSection.style.display = 'none';
      }

      // Missing keywords (truly not demonstrated) with "Add" option
      document.getElementById('keywords-missing').innerHTML =
        (analysis.keywordsMissing || []).map(k => `
          <span class="chip warning addable" data-keyword="${escapeHtml(k)}" data-original-class="warning">
            ${escapeHtml(k)}
            <button class="chip-add-btn" onclick="addSkillToResume('${escapeHtml(k).replace(/'/g, "\\'")}', this)" title="Add to your resume">+</button>
          </span>
        `).join('');

      // Recommendation
      document.getElementById('recommendation').textContent = analysis.recommendation;

      // Tailor button - disabled for basic analysis, enabled otherwise
      const tailorBtn = document.getElementById('tailor-btn');
      const tailorNote = document.getElementById('tailor-note');

      if (analysis.isBasicAnalysis) {
        // Disable tailoring for basic analysis (requires AI)
        tailorBtn.disabled = true;
        tailorBtn.classList.remove('btn-success', 'btn-warning');
        tailorBtn.style.backgroundColor = '#dadce0';
        tailorNote.innerHTML = 'Tailoring requires an AI provider. <a href="#" onclick="openAISettings(); return false;" style="color: #1a73e8;">Configure AI Settings</a>';
        tailorNote.style.color = '#5f6368';
      } else {
        tailorBtn.disabled = false;
        tailorBtn.style.backgroundColor = '';

        if (result.canTailor) {
          tailorBtn.classList.remove('btn-warning');
          tailorBtn.classList.add('btn-success');
          tailorNote.textContent = 'Great match! Click to create a tailored copy of your resume.';
          tailorNote.style.color = '#5f6368';
        } else {
          tailorBtn.classList.remove('btn-success');
          tailorBtn.classList.add('btn-warning');
          tailorNote.innerHTML = `Below your ${result.minScoreRequired}% threshold, but you can still tailor if you want to apply.`;
          tailorNote.style.color = '#b05a00';
        }
      }

      document.getElementById('results').classList.add('show');
    }

    function tailor() {
      if (!currentAnalysis || !jobDescription) {
        showError('Please analyze a job description first.');
        return;
      }

      // Show the pre-tailor questionnaire instead of immediately tailoring
      showPreTailorQuestionnaire();
    }

    function showPreTailorQuestionnaire() {
      // Hide analysis results
      document.getElementById('results').classList.remove('show');

      // Populate the gaps list with missing keywords and gaps
      const gapsList = document.getElementById('gaps-list');
      const gaps = [];

      // Add gaps from analysis
      if (currentAnalysis.gaps && currentAnalysis.gaps.length > 0) {
        gaps.push(...currentAnalysis.gaps);
      }

      // Add missing keywords
      if (currentAnalysis.keywordsMissing && currentAnalysis.keywordsMissing.length > 0) {
        gaps.push(...currentAnalysis.keywordsMissing);
      }

      if (gaps.length > 0) {
        gapsList.innerHTML = gaps.map(g => `<span class="chip warning">${escapeHtml(g)}</span>`).join('');
        document.getElementById('pre-tailor-gaps').style.display = 'block';
      } else {
        document.getElementById('pre-tailor-gaps').style.display = 'none';
      }

      // Clear any previous additional context
      document.getElementById('additional-context').value = '';

      // Show the pre-tailor section
      document.getElementById('pre-tailor').style.display = 'block';
    }

    function backToResults() {
      document.getElementById('pre-tailor').style.display = 'none';
      document.getElementById('results').classList.add('show');
    }

    function proceedWithTailoring() {
      const additionalContext = document.getElementById('additional-context').value.trim();

      // Hide pre-tailor section and show loading
      document.getElementById('pre-tailor').style.display = 'none';
      showLoading('Creating tailored copy and generating suggestions...');

      google.script.run
        .withSuccessHandler(handleTailoringResult)
        .withFailureHandler(handleError)
        .tailorForJob(jobDescription, currentAnalysis, candidateName, additionalContext);
    }

    function handleTailoringResult(result) {
      if (!result.success) {
        hideLoading();
        showError(result.error);
        document.getElementById('results').classList.add('show');
        return;
      }

      currentCopyId = result.copy.copyId;
      currentChanges = result.tailoring.changes || [];

      // Show copy link
      const copyLink = document.getElementById('copy-link');
      copyLink.href = result.copy.copyUrl;
      copyLink.textContent = result.copy.copyName;

      // Open the new document in a new tab
      window.open(result.copy.copyUrl, '_blank');

      // Apply all suggestions visually to the document
      if (currentChanges.length > 0) {
        showLoading('Applying suggestions to document...');
        google.script.run
          .withSuccessHandler(function(applyResult) {
            hideLoading();
            displayTailoringResults(result.tailoring, applyResult);
          })
          .withFailureHandler(function(err) {
            hideLoading();
            displayTailoringResults(result.tailoring, null);
          })
          .applyAllSuggestionsVisual(currentCopyId, currentChanges);
      } else {
        hideLoading();
        displayTailoringResults(result.tailoring, null);
      }
    }

    function displayTailoringResults(tailoring, applyResult) {
      // Hide the threshold slider
      document.getElementById('threshold-section').style.display = 'none';

      // Show the match score from analysis
      if (currentAnalysis && currentAnalysis.matchScore !== undefined) {
        const scoreEl = document.getElementById('tailoring-score');
        scoreEl.textContent = currentAnalysis.matchScore + '%';
        scoreEl.className = 'score ' + (
          currentAnalysis.matchScore >= 80 ? 'high' :
          currentAnalysis.matchScore >= 60 ? 'medium' : 'low'
        );
        document.getElementById('tailoring-match-score').style.display = 'block';
      } else {
        document.getElementById('tailoring-match-score').style.display = 'none';
      }

      const changesList = document.getElementById('changes-list');
      changesList.innerHTML = '';

      if (tailoring.changes && tailoring.changes.length > 0) {
        // Add info message about visual suggestions
        const infoMsg = document.createElement('div');
        infoMsg.style.cssText = 'background: #e8f0fe; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px; color: #174ea6;';
        infoMsg.innerHTML = `
          <strong>Suggestions applied to document!</strong><br>
          <span style="color: #ea4335; text-decoration: line-through;">Red strikethrough</span> = text to remove<br>
          <span style="color: #34a853;">Green text</span> = suggested replacement<br>
          Use the buttons below to accept or reject each change.
        `;
        changesList.appendChild(infoMsg);

        tailoring.changes.forEach((change, index) => {
          const card = document.createElement('div');
          card.className = 'change-card';
          card.id = 'change-' + index;
          card.innerHTML = `
            <div class="change-section">${change.section}</div>
            <div class="change-original" id="original-${index}">${escapeHtml(change.original)}</div>
            <div class="change-tailored" id="tailored-${index}">${escapeHtml(change.tailored)}</div>
            <div class="change-reason" id="reason-${index}">${escapeHtml(change.reason)}</div>
            <div class="change-actions" id="actions-${index}">
              <button class="btn btn-success" onclick="acceptChange(${index}, this)">Accept</button>
              <button class="btn btn-secondary" onclick="rejectChange(${index}, this)">Reject</button>
              <button class="btn btn-rephrase" onclick="showRephrasePanel(${index})">Rephrase</button>
            </div>
            <div class="rephrase-panel" id="rephrase-panel-${index}">
              <textarea id="rephrase-feedback-${index}" placeholder="What should be different? e.g., 'Don't mention payment systems - I have no experience with that' or 'Less embellishment, keep it factual'"></textarea>
              <div class="btn-row">
                <button class="btn btn-primary btn-small" onclick="submitRephrase(${index})">Regenerate</button>
                <button class="btn btn-secondary btn-small" onclick="hideRephrasePanel(${index})">Cancel</button>
              </div>
            </div>
          `;
          changesList.appendChild(card);
        });
      } else {
        changesList.innerHTML = '<p style="color: #5f6368;">No text changes suggested.</p>';
      }

      // Content removal suggestions section
      if (tailoring.contentToRemove && tailoring.contentToRemove.length > 0) {
        currentRemovals = tailoring.contentToRemove;

        const removalSection = document.createElement('div');
        removalSection.style.cssText = 'margin-top: 20px; padding-top: 16px; border-top: 1px solid #e0e0e0;';
        removalSection.innerHTML = `
          <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 500; color: #c5221f;">
            Consider Removing
          </h4>
          <p style="font-size: 12px; color: #5f6368; margin: 0 0 12px 0;">
            This content may not be relevant to the target role:
          </p>
        `;

        const removalList = document.createElement('div');
        removalList.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';

        tailoring.contentToRemove.forEach((item, index) => {
          const removalCard = document.createElement('div');
          removalCard.className = 'removal-suggestion';
          removalCard.id = 'removal-' + index;
          removalCard.style.cssText = 'background: #fce8e6; padding: 10px 12px; border-radius: 8px; font-size: 13px;';
          removalCard.innerHTML = `
            <div class="change-section" style="margin-bottom: 4px;">${escapeHtml(item.section)}</div>
            <div style="color: #c5221f; text-decoration: line-through; margin-bottom: 6px;">${escapeHtml(item.content)}</div>
            <div style="color: #5f6368; font-size: 11px; font-style: italic; margin-bottom: 8px;">${escapeHtml(item.reason)}</div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #c5221f; color: white; border: none;"
                      onclick="acceptRemoval(${index}, this)">Remove</button>
              <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;"
                      onclick="rejectRemoval(${index}, this)">Keep</button>
            </div>
          `;
          removalList.appendChild(removalCard);
        });

        removalSection.appendChild(removalList);
        changesList.appendChild(removalSection);
      }

      // Skills to add section
      if (tailoring.skillsToAdd && tailoring.skillsToAdd.length > 0) {
        const skillsSection = document.createElement('div');
        skillsSection.style.cssText = 'margin-top: 20px; padding-top: 16px; border-top: 1px solid #e0e0e0;';
        skillsSection.innerHTML = `
          <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 500; color: #202124;">
            Suggested Skills to Add
          </h4>
          <p style="font-size: 12px; color: #5f6368; margin: 0 0 12px 0;">
            These skills are implied by your experience but missing from your Skills section:
          </p>
        `;

        const skillsList = document.createElement('div');
        skillsList.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';

        tailoring.skillsToAdd.forEach((item, index) => {
          const skillCard = document.createElement('div');
          skillCard.className = 'skill-suggestion';
          skillCard.id = 'skill-suggestion-' + index;
          skillCard.style.cssText = 'background: #fef7e0; padding: 10px 12px; border-radius: 8px; font-size: 13px;';
          skillCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div>
                <strong style="color: #b05a00;">${escapeHtml(item.skill)}</strong>
                <span style="color: #5f6368; font-size: 11px;"> → ${escapeHtml(item.category)}</span>
              </div>
              <button class="btn btn-success" style="padding: 4px 10px; font-size: 11px; white-space: nowrap;"
                      onclick="addSuggestedSkill('${escapeHtml(item.skill).replace(/'/g, "\\'")}', this)">
                + Add
              </button>
            </div>
            <div style="color: #5f6368; font-size: 11px;">
              ${escapeHtml(item.justification)}
            </div>
          `;
          skillsList.appendChild(skillCard);
        });

        skillsSection.appendChild(skillsList);
        changesList.appendChild(skillsSection);
      }

      // Notes
      const notesEl = document.getElementById('tailoring-notes');
      if (tailoring.overallNotes) {
        notesEl.textContent = tailoring.overallNotes;
        notesEl.style.display = 'block';
      } else {
        notesEl.style.display = 'none';
      }

      document.getElementById('results').classList.remove('show');
      document.getElementById('tailoring-results').classList.add('show');
    }

    function addSuggestedSkill(skill, btn) {
      btn.disabled = true;
      btn.textContent = 'Adding...';
      const card = btn.closest('.skill-suggestion');

      // Add to the tailored copy, not the template
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            card.style.background = '#e6f4ea';
            card.querySelector('strong').style.color = '#137333';
            // Replace Add button with Remove button
            btn.textContent = '− Remove';
            btn.disabled = false;
            btn.style.background = '#fff';
            btn.style.color = '#c5221f';
            btn.style.border = '1px solid #c5221f';
            btn.className = 'btn btn-secondary';
            btn.onclick = function() { removeSuggestedSkill(skill, btn); };
          } else {
            btn.textContent = 'Failed';
            btn.style.background = '#fce8e6';
            btn.title = result.error || 'Failed to add';
            setTimeout(() => {
              btn.textContent = '+ Add';
              btn.style.background = '';
              btn.disabled = false;
            }, 2000);
          }
        })
        .withFailureHandler(function(err) {
          btn.textContent = 'Error';
          setTimeout(() => {
            btn.textContent = '+ Add';
            btn.disabled = false;
          }, 2000);
        })
        .addSkillToCopy(skill, currentCopyId);
    }

    function removeSuggestedSkill(skill, btn) {
      btn.disabled = true;
      btn.textContent = 'Removing...';
      const card = btn.closest('.skill-suggestion');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Reset card to original state
            card.style.background = '#fef7e0';
            card.querySelector('strong').style.color = '#b05a00';
            // Replace Remove button with Add button
            btn.textContent = '+ Add';
            btn.disabled = false;
            btn.style.background = '';
            btn.style.color = '';
            btn.style.border = '';
            btn.className = 'btn btn-success';
            btn.onclick = function() { addSuggestedSkill(skill, btn); };
          } else {
            btn.textContent = 'Failed';
            setTimeout(() => {
              btn.textContent = '− Remove';
              btn.disabled = false;
            }, 2000);
          }
        })
        .withFailureHandler(function(err) {
          btn.textContent = 'Error';
          setTimeout(() => {
            btn.textContent = '− Remove';
            btn.disabled = false;
          }, 2000);
        })
        .removeSkillFromCopy(skill, currentCopyId);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function addSkillToResume(skill, btn) {
      // Disable button and show loading state
      btn.disabled = true;
      btn.textContent = '...';
      const chip = btn.parentElement;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Store original class before changing
            const origClass = chip.dataset.originalClass || (chip.classList.contains('info') ? 'info' : 'warning');
            // Mark as added with a Remove button
            chip.classList.remove('warning', 'info');
            chip.classList.add('added');
            chip.dataset.originalClass = origClass; // Preserve for removal
            chip.innerHTML = `
              ${escapeHtml(skill)}
              <button class="chip-add-btn" onclick="removeSkillFromResume('${escapeHtml(skill).replace(/'/g, "\\'")}', this)" title="Remove from Skills section" style="background: rgba(197, 34, 31, 0.2); color: #c5221f;">−</button>
            `;
          } else {
            // Show error briefly, then restore
            btn.textContent = '!';
            btn.title = result.error || 'Failed to add';
            setTimeout(() => {
              btn.textContent = '+';
              btn.disabled = false;
              btn.title = 'Add to your resume';
            }, 2000);
          }
        })
        .withFailureHandler(function(err) {
          btn.textContent = '!';
          btn.title = err.message || 'Error';
          setTimeout(() => {
            btn.textContent = '+';
            btn.disabled = false;
            btn.title = 'Add to your resume';
          }, 2000);
        })
        .addSkillToTemplate(skill);
    }

    function removeSkillFromResume(skill, btn) {
      btn.disabled = true;
      btn.textContent = '...';
      const chip = btn.parentElement;
      const originalClass = chip.dataset.originalClass || 'warning';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Reset chip to original state with Add button
            chip.classList.remove('added');
            chip.classList.add(originalClass);
            chip.dataset.originalClass = originalClass; // Preserve for future toggles
            chip.innerHTML = `
              ${escapeHtml(skill)}
              <button class="chip-add-btn" onclick="addSkillToResume('${escapeHtml(skill).replace(/'/g, "\\'")}', this)" title="Add to Skills section">+</button>
            `;
          } else {
            btn.textContent = '!';
            btn.title = result.error || 'Failed to remove';
            setTimeout(() => {
              btn.textContent = '−';
              btn.disabled = false;
              btn.title = 'Remove from Skills section';
            }, 2000);
          }
        })
        .withFailureHandler(function(err) {
          btn.textContent = '!';
          btn.title = err.message || 'Error';
          setTimeout(() => {
            btn.textContent = '−';
            btn.disabled = false;
            btn.title = 'Remove from Skills section';
          }, 2000);
        })
        .removeSkillFromTemplate(skill);
    }

    function acceptChange(index, btn) {
      const change = currentChanges[index];
      if (!change || !currentCopyId) return;

      btn.disabled = true;
      btn.textContent = 'Accepting...';
      const card = document.getElementById('change-' + index);
      const rejectBtn = card.querySelector('.btn-secondary');
      if (rejectBtn) rejectBtn.disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            card.style.background = '#e6f4ea';
            card.style.opacity = '0.7';
            btn.textContent = 'Accepted';
            btn.disabled = true;
            if (rejectBtn) rejectBtn.style.display = 'none';
          } else {
            btn.textContent = 'Failed';
            setTimeout(() => {
              btn.textContent = 'Accept';
              btn.disabled = false;
              if (rejectBtn) rejectBtn.disabled = false;
            }, 2000);
          }
        })
        .withFailureHandler(function(err) {
          btn.textContent = 'Error';
          setTimeout(() => {
            btn.textContent = 'Accept';
            btn.disabled = false;
            if (rejectBtn) rejectBtn.disabled = false;
          }, 2000);
        })
        .acceptSuggestedChange(currentCopyId, change.original, change.tailored);
    }

    function rejectChange(index, btn) {
      const change = currentChanges[index];
      if (!change || !currentCopyId) return;

      btn.disabled = true;
      btn.textContent = 'Rejecting...';
      const card = document.getElementById('change-' + index);
      const acceptBtn = card.querySelector('.btn-success');
      if (acceptBtn) acceptBtn.disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            card.style.background = '#fce8e6';
            card.style.opacity = '0.7';
            btn.textContent = 'Rejected';
            btn.disabled = true;
            if (acceptBtn) acceptBtn.style.display = 'none';
          } else {
            btn.textContent = 'Failed';
            setTimeout(() => {
              btn.textContent = 'Reject';
              btn.disabled = false;
              if (acceptBtn) acceptBtn.disabled = false;
            }, 2000);
          }
        })
        .withFailureHandler(function(err) {
          btn.textContent = 'Error';
          setTimeout(() => {
            btn.textContent = 'Reject';
            btn.disabled = false;
            if (acceptBtn) acceptBtn.disabled = false;
          }, 2000);
        })
        .rejectSuggestedChange(currentCopyId, change.original, change.tailored);
    }

    function showRephrasePanel(index) {
      const panel = document.getElementById('rephrase-panel-' + index);
      if (panel) {
        panel.classList.add('show');
        // Hide the rephrase button since panel is now open
        const actions = document.getElementById('actions-' + index);
        const rephraseBtn = actions.querySelector('.btn-rephrase');
        if (rephraseBtn) rephraseBtn.style.display = 'none';
      }
    }

    function hideRephrasePanel(index) {
      const panel = document.getElementById('rephrase-panel-' + index);
      if (panel) {
        panel.classList.remove('show');
        // Show the rephrase button again
        const actions = document.getElementById('actions-' + index);
        const rephraseBtn = actions.querySelector('.btn-rephrase');
        if (rephraseBtn) rephraseBtn.style.display = '';
      }
    }

    function submitRephrase(index) {
      const change = currentChanges[index];
      if (!change) return;

      const feedbackEl = document.getElementById('rephrase-feedback-' + index);
      const feedback = feedbackEl ? feedbackEl.value.trim() : '';

      if (!feedback) {
        alert('Please enter what you want to change about this suggestion.');
        return;
      }

      // Store the OLD tailored text before we update it
      const oldTailored = change.tailored;

      // Get the job description from the input field
      const jobDescEl = document.getElementById('job-description');
      const jobDescription = jobDescEl ? jobDescEl.value.trim() : '';

      const panel = document.getElementById('rephrase-panel-' + index);
      const tailoredEl = document.getElementById('tailored-' + index);
      const reasonEl = document.getElementById('reason-' + index);

      // Show loading state
      panel.innerHTML = '<div style="text-align: center; padding: 12px; color: #5f6368;">Regenerating suggestion...</div>';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Update the document first (replace old green text with new)
            if (currentCopyId) {
              google.script.run
                .withSuccessHandler(function(docResult) {
                  if (!docResult.success) {
                    console.warn('Could not update document:', docResult.message);
                  }
                })
                .withFailureHandler(function(err) {
                  console.warn('Error updating document:', err);
                })
                .updateSuggestedChangeVisual(currentCopyId, change.original, oldTailored, result.tailored);
            }

            // Update the change in our local array
            currentChanges[index].tailored = result.tailored;
            currentChanges[index].reason = result.reason;

            // Update the UI
            tailoredEl.textContent = result.tailored;
            reasonEl.textContent = result.reason;

            // Hide the panel and restore the button
            panel.classList.remove('show');
            panel.innerHTML = `
              <textarea id="rephrase-feedback-${index}" placeholder="What should be different? e.g., 'Don't mention payment systems - I have no experience with that' or 'Less embellishment, keep it factual'"></textarea>
              <div class="btn-row">
                <button class="btn btn-primary btn-small" onclick="submitRephrase(${index})">Regenerate</button>
                <button class="btn btn-secondary btn-small" onclick="hideRephrasePanel(${index})">Cancel</button>
              </div>
            `;

            // Show success briefly
            tailoredEl.style.transition = 'background-color 0.3s';
            tailoredEl.style.backgroundColor = '#c8e6c9';
            setTimeout(() => {
              tailoredEl.style.backgroundColor = '';
            }, 1500);

            // Show the rephrase button again
            const actions = document.getElementById('actions-' + index);
            const rephraseBtn = actions.querySelector('.btn-rephrase');
            if (rephraseBtn) rephraseBtn.style.display = '';
          } else {
            panel.innerHTML = `
              <div style="color: #c5221f; margin-bottom: 8px;">Error: ${result.error || 'Failed to regenerate'}</div>
              <textarea id="rephrase-feedback-${index}" placeholder="What should be different?">${feedback}</textarea>
              <div class="btn-row">
                <button class="btn btn-primary btn-small" onclick="submitRephrase(${index})">Try Again</button>
                <button class="btn btn-secondary btn-small" onclick="hideRephrasePanel(${index})">Cancel</button>
              </div>
            `;
          }
        })
        .withFailureHandler(function(err) {
          panel.innerHTML = `
            <div style="color: #c5221f; margin-bottom: 8px;">Error: ${err.message || 'Failed to regenerate'}</div>
            <textarea id="rephrase-feedback-${index}" placeholder="What should be different?">${feedback}</textarea>
            <div class="btn-row">
              <button class="btn btn-primary btn-small" onclick="submitRephrase(${index})">Try Again</button>
              <button class="btn btn-secondary btn-small" onclick="hideRephrasePanel(${index})">Cancel</button>
            </div>
          `;
        })
        .rephraseChange(change.original, change.tailored, feedback, jobDescription);
    }

    function acceptRemoval(index, btn) {
      const removal = currentRemovals[index];
      if (!removal || !currentCopyId) return;

      btn.disabled = true;
      btn.textContent = 'Removing...';
      const card = document.getElementById('removal-' + index);
      const keepBtn = card.querySelector('.btn-secondary:not([style*="background: #c5221f"])');
      if (keepBtn) keepBtn.disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            card.style.background = '#e8eaed';
            card.style.opacity = '0.5';
            btn.textContent = 'Removed';
            btn.disabled = true;
            if (keepBtn) keepBtn.style.display = 'none';
          } else {
            btn.textContent = 'Failed';
            setTimeout(() => {
              btn.textContent = 'Remove';
              btn.disabled = false;
              if (keepBtn) keepBtn.disabled = false;
            }, 2000);
          }
        })
        .withFailureHandler(function(err) {
          btn.textContent = 'Error';
          setTimeout(() => {
            btn.textContent = 'Remove';
            btn.disabled = false;
            if (keepBtn) keepBtn.disabled = false;
          }, 2000);
        })
        .acceptRemoval(currentCopyId, removal.content);
    }

    function rejectRemoval(index, btn) {
      const removal = currentRemovals[index];
      if (!removal || !currentCopyId) return;

      btn.disabled = true;
      btn.textContent = 'Keeping...';
      const card = document.getElementById('removal-' + index);
      const removeBtn = card.querySelector('[style*="background: #c5221f"]');
      if (removeBtn) removeBtn.disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            card.style.background = '#e6f4ea';
            card.style.opacity = '0.7';
            btn.textContent = 'Kept';
            btn.disabled = true;
            if (removeBtn) removeBtn.style.display = 'none';
          } else {
            btn.textContent = 'Failed';
            setTimeout(() => {
              btn.textContent = 'Keep';
              btn.disabled = false;
              if (removeBtn) removeBtn.disabled = false;
            }, 2000);
          }
        })
        .withFailureHandler(function(err) {
          btn.textContent = 'Error';
          setTimeout(() => {
            btn.textContent = 'Keep';
            btn.disabled = false;
            if (removeBtn) removeBtn.disabled = false;
          }, 2000);
        })
        .rejectRemoval(currentCopyId, removal.content);
    }

    function acceptAllChanges() {
      if (!currentChanges.length || !currentCopyId) return;

      showLoading('Accepting all changes...');
      let completed = 0;
      let succeeded = 0;

      currentChanges.forEach((change, index) => {
        google.script.run
          .withSuccessHandler(function(result) {
            completed++;
            if (result.success) {
              succeeded++;
              const card = document.getElementById('change-' + index);
              if (card) {
                card.style.background = '#e6f4ea';
                card.style.opacity = '0.7';
                const btn = card.querySelector('.btn-success');
                if (btn) {
                  btn.textContent = 'Accepted';
                  btn.disabled = true;
                }
                const rejectBtn = card.querySelector('.btn-secondary');
                if (rejectBtn) rejectBtn.style.display = 'none';
              }
            }
            if (completed === currentChanges.length) {
              hideLoading();
              // Clear pending changes since all are processed
              google.script.run.clearPendingChanges(currentCopyId);
              alert(`Accepted ${succeeded} of ${currentChanges.length} changes. Check your document.`);
            }
          })
          .withFailureHandler(function() {
            completed++;
            if (completed === currentChanges.length) {
              hideLoading();
              google.script.run.clearPendingChanges(currentCopyId);
              alert(`Accepted ${succeeded} of ${currentChanges.length} changes. Check your document.`);
            }
          })
          .acceptSuggestedChange(currentCopyId, change.original, change.tailored);
      });
    }

    function rejectAllChanges() {
      if (!currentChanges.length || !currentCopyId) return;

      showLoading('Rejecting all changes...');
      let completed = 0;
      let succeeded = 0;

      currentChanges.forEach((change, index) => {
        google.script.run
          .withSuccessHandler(function(result) {
            completed++;
            if (result.success) {
              succeeded++;
              const card = document.getElementById('change-' + index);
              if (card) {
                card.style.background = '#fce8e6';
                card.style.opacity = '0.7';
                const btn = card.querySelector('.btn-secondary');
                if (btn) {
                  btn.textContent = 'Rejected';
                  btn.disabled = true;
                }
                const acceptBtn = card.querySelector('.btn-success');
                if (acceptBtn) acceptBtn.style.display = 'none';
              }
            }
            if (completed === currentChanges.length) {
              hideLoading();
              // Clear pending changes since all are processed
              google.script.run.clearPendingChanges(currentCopyId);
              alert(`Rejected ${succeeded} of ${currentChanges.length} changes. Original text restored.`);
            }
          })
          .withFailureHandler(function() {
            completed++;
            if (completed === currentChanges.length) {
              hideLoading();
              google.script.run.clearPendingChanges(currentCopyId);
              alert(`Rejected ${succeeded} of ${currentChanges.length} changes.`);
            }
          })
          .rejectSuggestedChange(currentCopyId, change.original, change.tailored);
      });
    }

    function reset() {
      document.getElementById('job-description').value = '';
      document.getElementById('results').classList.remove('show');
      document.getElementById('tailoring-results').classList.remove('show');
      document.getElementById('pre-tailor').style.display = 'none';
      document.getElementById('input-section').style.display = 'block';
      // Show the threshold slider again
      document.getElementById('threshold-section').style.display = 'block';
      currentAnalysis = null;  // Contains companyName and positionTitle from Claude
      jobDescription = '';
      candidateName = '';
      currentCopyId = null;
      currentChanges = [];
      currentRemovals = [];
      hideError();
      checkTemplateStatus();
    }

    function handleError(error) {
      hideLoading();
      document.getElementById('input-section').style.display = 'block';
      showError(error.message || 'An unexpected error occurred.');
    }
  </script>
</body>
</html>
